# mountingbiases
Process for determining CAMBOT mounting biases

This process is a highly manual one, but should only need to be done once a campaign or however often a camera is moved/re-mounted on the platform it is in. 

The files that are needed are:
**GCP_LatLon.csv** : this file contains all the latitude and longitude coordinates for each of the ground control points (GCP) that John and I measured on the ground with the total station
**GCP_XY_file.csv** : this file contains all the image specific location information for each selected test image. There is one line per GCP in each image, with the following information for each line, separated by commas: image name, GCP name, X-coordinate, Y-coordinate, Notes (optional field). All the GCPs for each image being used are in consective lines, with a series of dashes "------" separating the entries for each image from the next. The file is created manually, with X & Y coordinates of each GCP in an image found by opening the image in IDL using the command image(filename). The user clicks on the image opened and reads the X & Y coordinates off of the lower-right hand side of the iamge window when mousing over the GCP in question. IDL opens different image formats differently, so it is best to use IDL to open the image for this purpose, so we can ensure the X & Y coordinates are in the correct orientation.
**Lens_corrections_CAMBOT_XXXXXXXX.h5** : MATLAB generated lens-correction file, where XXXXXXXX is the serial number of the lens being used. Each lens/camera combination should be set, as lens corrections are setup as such. Lens corrections were generated with the Caltech Calibration Toolbox software package for MATLAB (See "How to Lens Calibration.txt" file for steps on using this toolbox to generated new corrections if required)
**YYYYMMDD_CAMBOT_ancillary_precise.csv** : ancillary file containing all aircraft attitude, location (lat, lon, elevation and range) and lever arm offsets for each flight. Generated by the ATM team.


Description of the process:
There are two main IDL Programs used in the mounting bias process:
**cambot_georeferencing_v2p0_mounting_bias.pro** : this program reads in all the files mentioned above and iterates through a set of preset mounting bias offsets, checking latitude and longitude coordinates for each GCP generated from their X & Y locations against real-world locations from the GCP_LatLon.csv file (what we will call offset distance from here on out). All mounting bias values for roll, pitch & yaw, as well as the offset distance calculated for each GCP, are output into an IDL save (.sav) file. A single IDL save file is generated for each image found in the GCP_XY_file.
**mounting_bias_best_fit_v1p4/pro** : this program reads in all the IDL save files output from the function above and combines them to give you the most accurate mounting bas combination of roll, pitch and yaw. I have previously used the lowest median distance to select the best mounting bias values, but this is up to the user. 


Actually running things:
Starting with **cambot_georeferencing_v2p0_mounting_bias.pro**, begin with ensuring you have all the directories mapped correctly. The code is currently setup for multiple IceBridge CAMBOT campaigns, based upon campaign name, but this should be changed to work with whatever file organization system the user has.

Next, I just want to bring the user's attention to the rotate *"input image and GCP coordinates so that flight direction is upwards"* section. Here is where, based upon camera orientation, we are going to possibly need to rotate the image & adjust GCP coordinates such that the top of the image is in the direction of the flight. This is going to have to be determined iteratively, looking at output from the code and determining if a change needs to be made. I like to run a single test flight image through the actual imagery georeferencing code, with all mounting biases set to 0.0, and see if the geotiff that is output has its orientation align correctly with the background imagery in say, ArcMap. That requires a bit of back and forth setting up the actual production code while setting this mounting bias code up, but it all has to get done in the end anyway. 

Next, under the *camera settings and mounting bias values* section, the "camera_offset" variable should be setup with values from the ancillary file header. 

Now, we get to the actual meat of the code, where the setup is done and the iterative component comes in. Under the section heading *These values are all manually entered and updated as each iteration gets us closer to the actual mounting bias value for a specific campaign*, we set the "pitch_bias", "roll_bias" and "heading_bias" variables initially to 0.0. These are the values we start from, that we iteratively add +/- offsets to, to look for the best fit. The other values we need to setup control the iteration steps we iterate through. "pm_check" is the total +/- value we iterate to for pitch and roll, while "dpm" is the step we take in each pitch and roll iteration. "hm_check" and "dhm" are the same, but for heading offsets. I separated out heading from pitch and roll, as the heading offset is often quite small, while pitch and roll can get quite large. For my first run through, I often set "pm_check" and "hm_check" to 5.0, with "dpm" and "dhm" to 0.1. 

Finally, we run the code. It's setup to run in parallel, each worker taking a subset of bias offset permutations. 

Once it's done, we run the **mounting_bias_best_fit_v1p4.pro** code. This program is quite simple to setup, in that you simply setup the variable "in_dir" to point to the directory with all the .sav files we just generated and hit go. The stats for each image will be output to the screen, but at the end, an overall selection for the best fit roll, pitch and yaw offset will be printed to screen, with the median offset for each GCP. This is where you can double-check and see if there are any GCPs with unusually large offset distances. Assuming the image orientation is setup correctly, a large offset distance for only a few GCPs and not most of them, can mean an X & Y value entered in the **GCP_XY_file.csv** file may have a typo. If everything looks good, we take the best fit roll, pitch and yaw values from this code and enter them back into the "pitch_bias", "roll_bias" and "heading_bias" variables in the **cambot_georeferencing_v2p0_mounting_biases code**. We also update the "hm_check", "dhm", "pm_check" and "phm" values to be progressively smaller, as we hone in on the best overall mounting bias values. My second run of this code often has "hm_check" & "pm_check" set to 1.0 and "dhm" & "phm" set to 0.01. The third iteration of the code has them down to 0.1 and 0.001. 

Before we hit go on this code for the second time, we need to move the .sav files generated from the last run to a different location, as they will just end up being overwritten otherwise.

Once you have iterated through this process a few times and have narrowed down on the best mounting biases, transfer this information to both the land ice and sea ice georeferencing codes (cambot_geo_function_landice_v6p1.pro & cambot_geo_function_seaice_v4p0.pro). If you haven't already done it as well, setup the image rotation section in both these codes, as well as the "camera_offset" variable. 
